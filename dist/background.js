class i{constructor(){this.setupEventListeners()}setupEventListeners(){chrome.runtime.onInstalled.addListener(e=>{e.reason==="install"?this.handleFirstInstall():e.reason==="update"&&this.handleUpdate()}),chrome.runtime.onMessage.addListener((e,r,a)=>(this.handleMessage(e,r,a),!0)),chrome.action.onClicked.addListener(e=>{this.handleActionClick(e)})}async handleFirstInstall(){console.log("Extensão instalada pela primeira vez");try{const e=await chrome.windows.getCurrent();await chrome.sidePanel.open({windowId:e.id}),console.log("Side panel aberto com sucesso")}catch(e){console.error("Erro ao abrir side panel:",e),await chrome.tabs.create({url:chrome.runtime.getURL("options.html")})}}async handleUpdate(){console.log("Extensão atualizada");try{(await chrome.storage.sync.get("userSettings")).userSettings&&console.log("Configurações existentes encontradas")}catch(e){console.error("Erro ao verificar configurações:",e)}}async handleActionClick(e){console.log("Clique na extensão detectado");try{if(e.windowId)await chrome.sidePanel.open({windowId:e.windowId}),console.log("Side panel aberto com sucesso");else{const r=await chrome.windows.getCurrent();await chrome.sidePanel.open({windowId:r.id}),console.log("Side panel aberto na janela atual")}}catch(r){console.error("Erro ao abrir side panel:",r);try{const o=(await chrome.storage.sync.get("userSettings")).userSettings;o!=null&&o.isConfigured?(console.log("Tentando fallback para popup..."),console.error("Side panel não disponível. Verifique se o Chrome suporta side panels.")):(await chrome.tabs.create({url:chrome.runtime.getURL("options.html")}),console.log("Página de opções aberta como fallback"))}catch(a){console.error("Erro ao verificar configurações:",a),await chrome.tabs.create({url:chrome.runtime.getURL("options.html")})}}}async executeOnTab(e,r){try{await chrome.tabs.sendMessage(e,{type:"EXECUTE_STEP",step:r})}catch(a){throw console.error("Erro ao executar ação na aba:",a),a}}async checkPermissions(e){try{return await chrome.permissions.contains({permissions:e})}catch(r){return console.error("Erro ao verificar permissões:",r),!1}}async handleMessage(e,r,a){try{switch(e.type){case"GET_ACTIVE_TAB":const o=await chrome.tabs.query({active:!0,currentWindow:!0});a({tab:o[0]});break;case"EXECUTE_ON_TAB":await this.executeOnTab(e.tabId,e.action),a({success:!0});break;case"CHECK_PERMISSIONS":const s=await this.checkPermissions(e.permissions);a({hasPermissions:s});break;case"GET_MODELS":const t=await this.getAvailableModels(e.provider,e.apiKey);a({models:t});break;default:a({error:"Tipo de mensagem não reconhecido"})}}catch(o){console.error("Erro ao processar mensagem:",o),a({error:o.message})}}async getAvailableModels(e,r){try{switch(e){case"openai":return await this.getOpenAIModels(r);case"gemini":return await this.getGeminiModels(r);case"ollama":return await this.getOllamaModels(r);default:return this.getDefaultModels(e)}}catch(a){return console.error("Erro ao buscar modelos:",a),this.getDefaultModels(e)}}async getOpenAIModels(e){try{const r=await fetch("https://api.openai.com/v1/models",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!r.ok)throw new Error(`Erro na API OpenAI: ${r.statusText}`);return(await r.json()).data.filter(o=>o.id.includes("gpt")).map(o=>o.id).sort()}catch(r){return console.error("Erro ao buscar modelos OpenAI:",r),this.getDefaultModels("openai")}}async getGeminiModels(e){try{const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${e}`);if(!r.ok)throw new Error(`Erro na API Gemini: ${r.statusText}`);return(await r.json()).models.filter(o=>o.name.includes("gemini")).map(o=>o.name.split("/").pop()).sort()}catch(r){return console.error("Erro ao buscar modelos Gemini:",r),this.getDefaultModels("gemini")}}async getOllamaModels(e){try{const r=await fetch(`${e}/api/tags`);if(!r.ok)throw new Error(`Erro no Ollama: ${r.statusText}`);return(await r.json()).models.map(o=>o.name).sort()}catch(r){return console.error("Erro ao buscar modelos Ollama:",r),this.getDefaultModels("ollama")}}getDefaultModels(e){switch(e){case"openai":return["gpt-3.5-turbo","gpt-4","gpt-4-turbo-preview"];case"gemini":return["gemini-pro","gemini-pro-vision"];case"ollama":return["llama2","codellama","mistral"];default:return[]}}async cleanupOldData(){try{const e=await chrome.storage.local.get(),a=Date.now()-7*24*60*60*1e3,o=[];Object.entries(e).forEach(([s,t])=>{typeof t=="object"&&t.timestamp&&t.timestamp<a&&o.push(s)}),o.length>0&&(await chrome.storage.local.remove(o),console.log(`Limpeza concluída: ${o.length} itens removidos`))}catch(e){console.error("Erro na limpeza de dados:",e)}}}const c=new i;chrome.alarms.create("cleanup",{periodInMinutes:24*60});chrome.alarms.onAlarm.addListener(n=>{n.name==="cleanup"&&c.cleanupOldData()});
