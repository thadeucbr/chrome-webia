class c{constructor(){this.setupEventListeners()}setupEventListeners(){chrome.runtime.onInstalled.addListener(e=>{e.reason==="install"?this.handleFirstInstall():e.reason==="update"&&this.handleUpdate()}),chrome.runtime.onMessage.addListener((e,r,a)=>(this.handleMessage(e,r,a),!0)),chrome.action.onClicked.addListener(e=>{this.handleActionClick(e)})}async handleFirstInstall(){console.log("Extensão instalada pela primeira vez");try{await chrome.tabs.create({url:chrome.runtime.getURL("options.html")})}catch(e){console.error("Erro ao abrir página de opções:",e)}}async handleUpdate(){console.log("Extensão atualizada");try{(await chrome.storage.sync.get("userSettings")).userSettings&&console.log("Configurações existentes encontradas")}catch(e){console.error("Erro ao verificar configurações:",e)}}async handleMessage(e,r,a){try{switch(e.type){case"GET_ACTIVE_TAB":const t=await chrome.tabs.query({active:!0,currentWindow:!0});a({tab:t[0]});break;case"EXECUTE_ON_TAB":await this.executeOnTab(e.tabId,e.action),a({success:!0});break;case"CHECK_PERMISSIONS":const s=await this.checkPermissions(e.permissions);a({hasPermissions:s});break;case"GET_MODELS":const o=await this.getAvailableModels(e.provider,e.apiKey);a({models:o});break;default:a({error:"Tipo de mensagem não reconhecido"})}}catch(t){console.error("Erro ao processar mensagem:",t),a({error:t.message})}}async handleActionClick(e){try{const a=(await chrome.storage.sync.get("userSettings")).userSettings;a!=null&&a.isConfigured||await chrome.tabs.create({url:chrome.runtime.getURL("options.html")})}catch(r){console.error("Erro ao verificar configurações:",r)}}async executeOnTab(e,r){try{await chrome.tabs.sendMessage(e,{type:"EXECUTE_STEP",step:r})}catch(a){throw console.error("Erro ao executar ação na aba:",a),a}}async checkPermissions(e){try{return await chrome.permissions.contains({permissions:e})}catch(r){return console.error("Erro ao verificar permissões:",r),!1}}async getAvailableModels(e,r){try{switch(e){case"openai":return await this.getOpenAIModels(r);case"gemini":return await this.getGeminiModels(r);case"ollama":return await this.getOllamaModels(r);default:return[]}}catch(a){return console.error("Erro ao buscar modelos:",a),[]}}async getOpenAIModels(e){try{const r=await fetch("https://api.openai.com/v1/models",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!r.ok)throw new Error(`Erro na API OpenAI: ${r.statusText}`);return(await r.json()).data.filter(t=>t.id.includes("gpt")).map(t=>t.id).sort()}catch(r){return console.error("Erro ao buscar modelos OpenAI:",r),["gpt-3.5-turbo","gpt-4","gpt-4-turbo-preview"]}}async getGeminiModels(e){try{const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${e}`);if(!r.ok)throw new Error(`Erro na API Gemini: ${r.statusText}`);return(await r.json()).models.filter(t=>t.name.includes("gemini")).map(t=>t.name.split("/").pop()).sort()}catch(r){return console.error("Erro ao buscar modelos Gemini:",r),["gemini-pro","gemini-pro-vision"]}}async getOllamaModels(e){try{const r=await fetch(`${e}/api/tags`);if(!r.ok)throw new Error(`Erro no Ollama: ${r.statusText}`);return(await r.json()).models.map(t=>t.name).sort()}catch(r){return console.error("Erro ao buscar modelos Ollama:",r),["llama2","codellama","mistral"]}}async cleanupOldData(){try{const e=await chrome.storage.local.get(),a=Date.now()-7*24*60*60*1e3,t=[];Object.entries(e).forEach(([s,o])=>{typeof o=="object"&&o.timestamp&&o.timestamp<a&&t.push(s)}),t.length>0&&(await chrome.storage.local.remove(t),console.log(`Limpeza concluída: ${t.length} itens removidos`))}catch(e){console.error("Erro na limpeza de dados:",e)}}}const i=new c;chrome.alarms.create("cleanup",{periodInMinutes:24*60});chrome.alarms.onAlarm.addListener(n=>{n.name==="cleanup"&&i.cleanupOldData()});
